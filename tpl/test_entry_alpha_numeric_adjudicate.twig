{##
 # test_entry_alpha_numeric_adjudicate.twig
 # 
 # Adjudicate an alpha_numeric type test.
 # @author Dean Inglis <inglisd@mcmaster.ca>
 # @see base_view.twig for parameters
 #}
{% extends "widget.twig" %}

{% block javascript %}

  {{ parent() }}

  <script type="text/javascript">

    var table_selector = "#{{ widget.full }}__entry_table";

    function configure_ui() {
      var disable = false;
      $( table_selector + ' input:text[id$="adjudicate"]').each( function() {
        var id_1 = "#" + $(this).prop( "id" ).split( "__" )[0] + "__accept";
        var id_2 = "#" + $(this).prop( "id" ).split( "__" )[1] + "__accept";
        if( ! ( $( id_1 ).prop( "checked" ) || $( id_2 ).prop( "checked" ) ) &&
            0 == $(this).val().length ) { 
          var blank_id = '#' + $(this).prop( "id" ).replace( "adjudicate", "blank" );
          if( ! $( blank_id ).prop( "checked" ) ) {
            disable = true;
            return false;
          }  
        }
      } );

      $( "#{{ parent.full }}_Submit" ).button( { disabled : disable } );
    }

    $( function () {

      configure_ui();

      $( "#{{ parent.full }}_Submit" ).click( function() {
        var args = new Object();
        var columns = new Object();
        var data = new Object();
        columns["participant_id"] = {{ participant_id }};
        columns["test_id"] = {{ test_id }};
        columns["completed"] = 1;
        columns["id_1"] = {{ id_1 }};
        columns["id_2"] = {{ id_2 }};

        // collect the adjudication entries
        $( table_selector + ' input:text[id$="adjudicate"]' ).each( function() {
          var rank = $(this).prop( "id" ).split( "__" )[2];
          data[rank] = { 'word_candidate' : $(this).val() };
        } );
 
        columns["data"] = data;
        args.columns = columns;

        // push new test_entry
        if( ajax_push( "{{ parent.subject }}", "new", args ) ) {
          // disable Submit button and navigate to next page
          $( "#{{ parent.full }}_Submit" ).button( { disabled : true } );
          $( "#{{ parent.full }}_Next" ).trigger( "click" );
        }
      } );// end Submit button click

      $( table_selector + ' input:radio[value="accept"]' ).change(
        function() {
        var entry_id = $(this).prop( "id" ).split( "__" )[0];
        var target_text_id = '#' + $(this).prop( "name" ) + "__adjudicate";
        var blank_id = target_text_id.replace( "adjudicate", "blank" );
        $( blank_id ).removeProp( "checked" );
        var source_text_id = '#' + entry_id + "__candidate";
        var candidate = $( source_text_id ).val();
        $( target_text_id ).val( candidate );
        $( target_text_id ).attr( "value", candidate );
        $( target_text_id ).removeProp( "disabled" );

        configure_ui();
        } )
      .click( function () {

        $( table_selector + ' input:checkbox[value="all"]' ).removeProp( "checked" );

      } );// end radio input change and click

      $( table_selector + ' input:text[id$="adjudicate"]' ).change( function() {
        var id_1 = '#' + $(this).prop( "id" ).split( "__" )[0] + "__accept";
        var id_2 = '#' + $(this).prop( "id" ).split( "__" )[1] + "__accept";
        // uncheck the accept radio and checkbox inputs
        $( id_1 ).removeProp( "checked" );
        $( id_2 ).removeProp( "checked" );
        $( table_selector + ' input:checkbox[value="all"]' ).removeProp( "checked" );

        var candidate = $(this).val().trim().toLowerCase();
        $(this).val( candidate );
        $(this).attr( "value", candidate );

        var blank_id = '#' + $(this).prop( "id" ).replace( "adjudicate", "blank" );

        if( 0 == candidate.length ) {
          $( blank_id ).prop( "checked", true );
        } else {
          var args = new Object();
          args.id = {{ test_id }};
          args["language"] = "{{ language }}";
          args["word_candidate"] = candidate;
          var classification = ajax_pull( "test", "classify_word", args );
          if( classification != 'primary' ) {
            alert( 'Warning: the entry "' + candidate + '"is a candidate word. ' + 
                   'Candidate words must be either an integer or a letter from a-z.' );
          }
          $( blank_id ).removeProp( "checked" );
        }

        configure_ui();
      } );// end text input change

      $( table_selector + ' input:checkbox[value="all"]' ).click( function() {
        // toggle check state of companion All checkbox
        $( table_selector + ' input:checkbox[value="all"]' ).not($(this)).removeProp( "checked" );
        $(this).prop( "checked", $(this).prop( "checked" ) );
        $( table_selector + ' input:checkbox[value="blank"]' ).removeProp( "checked" );
        if( $(this).prop( "checked" ) ) {
          var id = $(this).prop( "id" ).split("__")[3];
          $radio_selector = $( table_selector + " div.radio__accept__" + id + " :radio" );
          $radio_selector.prop( "checked", true ).trigger( "change" );
        } else {
          $( table_selector + ' input:radio[value="accept"]' ).removeProp( "checked" );
          $text_selector = $( table_selector + ' input:text[id$="adjudicate"]' ); 
          $text_selector.prop( "disabled", true );  
          // update previous and present state of value
          $text_selector.val( "" );  
          $text_selector.attr( "value", "" );  
        }

        configure_ui();
      } );// end All checkbox click

    } );
  </script>

{% endblock javascript %}

{% block widget %}

  <div class="spacer"></div>

  {% if entry_data is empty %}

    <caption style="text-align: left;">
      <strong>No adjudication required. Please press Prev, Next or Quit</strong>
    </caption>

  {% else %}

    <table id="{{ widget.full }}__entry_table"
           border="1">

      <thead>
        <tr style="height:40px">
          <th>Entry #</th>
          <th colspan="2">"{{ user_1 }}"</th>
          <th colspan="2">"{{ user_2 }}"</th>
          <th>Adjudication</th>
        </tr>
      </thead>

      <tbody>
      {% for entry in entry_data %}
        <tr>
          <td class="heading" style="text-align:center">{{ entry.rank }}</td>

          {% set value_1 = '' %}
          {% set value_2 = '' %}

          {% if entry.word_id_1 is defined %}
            {% set value_1 = entry.word_1 %}  
          {% endif %}
          {% if entry.word_id_2 is defined %}
            {% set value_2 = entry.word_2 %}
          {% endif %}

          <td>
            <input type="text"
              style="width:10%; text-align:center"
              id="{{ entry.id_1 }}__candidate"
              readonly
              value="{{ value_1 }}">
          </td>

          {% if entry.adjudicate is defined %}
            <td bgcolor=#B1F3B1>
              <div class="radio__accept__1">
                <input type="radio"
                  id="{{ entry.id_1 }}__accept"
                  name="{{ entry.id_1 }}__{{ entry.id_2 }}__{{ entry.rank }}"
                  value="accept">
                <label for="{{ entry.id_1 }}__accept">Accept</label>
              </div>
            </td>
          {% else %}
            <td></td>
          {% endif %}

          <td>
            <input type="text"
              style="width:10%; text-align:center"
              id="{{ entry.id_2 }}__candidate"
              readonly
              value="{{ value_2 }}">
          </td>

          {% if entry.adjudicate is defined %}
            <td bgcolor=#B1F3B1>
              <div class="radio__accept__2">
                <input type="radio"
                  id="{{ entry.id_2 }}__accept"
                  name="{{ entry.id_1 }}__{{ entry.id_2 }}__{{ entry.rank }}"
                  value="accept">
                <label for="{{ entry.id_2 }}__accept">Accept</label>
              </div>
            </td>
            <td>
              <div class="adjudicate">
                <input type="text"
                  style="width:10%; text-align:center"
                  id="{{ entry.id_1 }}__{{ entry.id_2 }}__{{ entry.rank }}__adjudicate"
                  disabled
                  value="">
                <input type="checkbox"
                  id="{{ entry.id_1 }}__{{ entry.id_2 }}__{{ entry.rank }}__blank"
                  name="{{ entry.id_1 }}__{{ entry.id_2 }}__{{ entry.rank }}"
                  readonly
                  disabled
                  value="blank">
              </div>  
             </td>
          {% else %}
            <td></td><td></td>
          {% endif %}
        </tr>
      {% endfor %}

        <tr>
          <td colspan="2"></td>
          <td bgcolor=#B1F3B1>
            <input type="checkbox"
              id="{{ widget.full }}__accept__all__1"
              name="{{ widget.full }}__accept__all"
              value="all">
              <label for="{{ widget.full }}__accept__all__1">All</label>
          </td>
          <td></td>
          <td bgcolor=#B1F3B1>
            <input type="checkbox"
              id="{{ widget.full }}__accept__all__2"
              name="{{ widget.full }}__accept__all"
              value="all">
              <label for="{{ widget.full }}__accept__all__2">All</label>
          </td>
          <td></td>
        </tr>

      </tbody>
    </table>

  {% endif %}

{% endblock widget %}

