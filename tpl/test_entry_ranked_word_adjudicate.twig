{##
 # test_entry_ranked_word_adjudicate.twig
 # 
 # Adjudicate a ranked word test.
 # @author Dean Inglis <inglisd@mcmaster.ca>
 # @see base_view.twig for parameters
 #}
{% extends "widget.twig" %}

{% block javascript %}

  {{ parent() }}

  <script type="text/javascript">
    
    var table_selector = "#{{ widget.full }}__entry_table";

    function configure_ui() {
      // check the non-intrusion entries
      var numTotal = 
        $( table_selector + ' input:radio[name$="adjudicate"]' ).not(
         '[name*="intrusion"]' ).length / 3;
      var numYes = 
        $( table_selector + ' input:radio[value="yes"][name$="adjudicate"]:checked' ).length;
      var numNo = 
        $( table_selector + ' input:radio[value="no"][name$="adjudicate"]:checked' ).length;
      var numVariant = 
        $( table_selector + ' input:radio[value="variant"][name$="adjudicate"]:checked' ).length;

      var disable = ( numYes + numNo + numVariant ) != numTotal;

      // check the intrusion entries
      if( !disable ) {
        $( table_selector + ' input:text[id$="intrusion"]').each( function() {
          var id_1 = '#' + $(this).prop( "id" ).split( "__" )[0] + 
            "__intrusion__accept";
          var id_2 = '#' + $(this).prop( "id" ).split( "__" )[1] +
            "__intrusion__accept";
          if( ! ( $( id_1 ).prop( "checked" ) || $( id_2 ).prop( "checked" ) ) &&
              0 == $(this).val().length ) { 
            disable = true;
            return false;
          }
        } );      
      }

      $( "#{{ parent.full }}_Submit" ).button( { disabled : disable } );
    }

    // overrides the default autocomplete filter function to search only from the beginning
    // of the string
    $.ui.autocomplete.filter = function ( array, term ) {
      var matcher = new RegExp( "^" + $.ui.autocomplete.escapeRegex( term ), "i" );
      return $.grep( array, function ( value ) {
        return matcher.test( value.label || value.value || value );
      } );
    };

    function get_variant_text_complete() {
      var args = new Object();
      args["variant_dictionary_id"] = {{ variant_dictionary_id }};
      args["language"] = "{{ language }}";
      args["words_only"] = 1;
      return ajax_pull( "word", "list", args );
    }

    function get_intrusion_text_complete() {
      var args = new Object();
      args["intrusion_dictionary_id"] = {{ intrusion_dictionary_id }};
      args["language"] = "{{ language }}";
      args["words_only"] = 1;
      return ajax_pull( "word", "list", args );
    }

    $( function () {
     
      configure_ui();

      //hijack all the non-accept radio buttons so that
      //a non-greyed out appearance can be maintained instead
      //of assigning the disabled attribute
      $( table_selector + 
        ' input:radio[value!="accept"]:not([name$="adjudicate"])' ).click(function(e) {
        e.preventDefault();
        return false;
      });

      $( table_selector + ' input:text[id$="adjudicate"]' ).autocomplete( {
        source: get_variant_text_complete(),
        minLength: 1,
        select: function( event, ui ) {
          $(this).val( ui.item.value );
          $(this).attr( "value", ui.item.value );
          }
        } );

      $( table_selector + ' input:text[id$="intrusion"]' ).autocomplete( {
        source: get_intrusion_text_complete(),
        minLength: 1,
        select: function( event, ui ) {
          $(this).val( ui.item.value );
          $(this).attr( "value", ui.item.value );
          }
        } );

      $( "#{{ parent.full }}_Submit" ).click( function() {
        var args = new Object();
        var columns = new Object();
        var data = new Object();
        var intrusion_data = new Object();
        columns["participant_id"] = {{ participant_id }};
        columns["test_id"] = {{ test_id }};
        columns["completed"] = 1;
        columns["id_1"] = {{ id_1 }};
        columns["id_2"] = {{ id_2 }};
        $( table_selector + ' input:radio[name$="adjudicate"]:checked' ).each( function() {
          var id = $(this).prop( "id" ).split( "__" )[0] + "__" + $(this).val();
          var word_id = 
            $( table_selector + ' input:radio[id="' + id + '"]' ).prop( "name" ).split( "__" )[0];
          var candidate = "";
          if( $(this).val() === "variant" ) {
            candidate = 
              $( table_selector + ' input:text[id="' + $(this).prop( "name" ) + '"]' ).val();
          } 
          data[word_id] = { 'selection' : $(this).val(), 'word_candidate' : candidate };
        } );
        
        var rank = 1;
        $( table_selector + ' input:text[id$="intrusion"]' ).each( function() {
          intrusion_data[rank] = $(this).val();
          rank = rank + 1;
        } );
 
        if( 0 < data.length ) {
          columns["data"] = data;
        }
        if( 0 < intrusion_data.length ) {
          columns["intrusion_data"] = intrusion_data;
        }  
        args.columns = columns;

        if( ajax_push( "{{ parent.subject }}", "new", args ) ) {
          $( "#{{ parent.full }}_Submit" ).button( { disabled : true } );
          $( "#{{ parent.full }}_Next" ).trigger( "click" );
        }
      } );// end Submit button click

      // find and handle radio input change events:
      // copy the progenitor to the adjudicate entry
      $( table_selector + ' input:radio[value="accept"]' ).change( function() {

        var is_intrusion = -1 != $(this).prop( "id" ).indexOf( "intrusion" );
        var entry_id = $(this).prop( "id" ).split( "__" )[0];

        if( is_intrusion ) {
          var target_text_id = 
            '#' + $(this).prop( "name" ).replace( "accept", "intrusion" );
          var source_text_id = '#' + entry_id + "__intrusion__source";
          $( target_text_id ).removeProp( "disabled" );
          $( target_text_id ).removeClass( "candidate primary intrusion variant" );
          var candidate = "";
          if( 0 < entry_id.length ) {
            $( target_text_id ).addClass( $( source_text_id ).prop( "class" ) );
            candidate = $( source_text_id ).val();
          }
          $( target_text_id ).val( candidate );
          $( target_text_id ).attr( candidate );
        } else {
          var radio_id =
            $( table_selector + ' input:radio[id^="' + entry_id + '__"]:checked').prop( "id" );
          var target_text_id = '#' + 
            $( table_selector + ' input:text[id*="'+ entry_id + '__"][id$="adjudicate"]' ).prop( "id" );
          $( target_text_id ).removeClass( "candidate primary intrusion variant" );
          if( -1 != radio_id.indexOf( "variant" ) ) {
            var source_text_id = '#' + radio_id.replace( "variant", "candidate" );
            $( target_text_id ).val( $( source_text_id ).val() );
            $( target_text_id ).prop( "disabled", false );
            $( target_text_id ).addClass( $( source_text_id ).prop( "class" ) );
          } else {
            $( target_text_id ).val( "" );
            $( target_text_id ).attr( "value", "" );
            $( target_text_id ).prop( "disabled", true );
          }
          var source_id = '#' + radio_id;
          var source_value = $( source_id ).val();
          var target_id = '#' +
            $( table_selector + ' input:radio[id*="' +
            entry_id + '__"][name$="adjudicate"][value="' +
            source_value + '"]' ).prop( "id" );
          $( target_id ).prop( "checked", $( source_id ).prop( "checked" ) );
        }

        configure_ui();
      } )
      .click( function () {

        $( table_selector + ' input:checkbox' ).removeProp( "checked" );

      } );// end radio input change and click

      $( table_selector + ' input:radio[name$="adjudicate"]' ).change( function() {
        var disable = -1 == $(this).prop( "id" ).indexOf( "variant" ); 
        var target_text_id = '#' +  $(this).prop( "name" );
        $( target_text_id ).removeClass( "candidate primary intrusion variant" );
        if( disable ) {
          $( target_text_id ).prop( "disabled", true );
          $( target_text_id ).val( "" );
          // update the value to present state
          $( target_text_id ).attr( "value", "" );
        } else {
          $( target_text_id ).prop( "disabled", false );
          $( target_text_id ).focus();
        }
        // ensure corresponding Accept radio inputs are unchecked
        var id_1 = '#' + $(this).prop( "id" ).split( "__" )[0] + "__accept";
        var id_2 = '#' + $(this).prop( "id" ).split( "__" )[1] + "__accept";
        $( id_1 ).removeProp( "checked" ); 
        $( id_2 ).removeProp( "checked" ); 

        // uncheck the "All" checkboxes if not all Accept radio items are selected
        $( table_selector + ' input:checkbox' ).removeProp( "checked" );  

        configure_ui();
      } );// end adjudicate radio input change

      $( table_selector + ' div.adjudicate :text' ).change( function() {
        var is_intrusion = -1 != $(this).prop( "id" ).indexOf( "intrusion" );
        var id_1 = '#' + $(this).prop( "id" ).split( "__" )[0] + 
          (is_intrusion ? "__intrusion__accept" : "__accept");
        var id_2 = '#' + $(this).prop( "id" ).split( "__" )[1] +
          (is_intrusion ? "__intrusion__accept" : "__accept");
        $( id_1 ).removeProp( "checked" );  
        $( id_2 ).removeProp( "checked" );  

        var candidate = $(this).val().trim().toLowerCase();
        $(this).val( candidate );
        $(this).attr( "value", candidate );
        $(this).removeClass( "candidate primary intrusion variant" );

        // if this is an intrusion, allow an empty input
        if( 0 == candidate.length ) {
          if( !is_intrusion ) {
            alert ( "Blank entries are not permitted" );
            return false;
          }
        } else {
          var args = new Object();
          args.id = {{ test_id }};
          args["language"] = "{{ language }}";
          args["word_candidate"] = candidate;
          var classification = ajax_pull( "test", "classify_word", args );
          $(this).addClass( classification );
        }

        configure_ui();
      } );// end text input change  

      $( table_selector + ' input:checkbox[value="all"]' ).click( function() {
        // toggle check state of companion All checkbox
        $( table_selector + ' input:checkbox[value="all"]' ).not($(this)).removeProp( "checked" );
        $(this).prop( "checked", $(this).prop( "checked" ) );
        if( $(this).prop( "checked" ) ) {
          // copy checked radio items from progenitor to adjudicate
          var id = $(this).prop( "id" ).split("__")[3];
          var radio_selector_id = " div.radio__accept__" + id + " :radio";
          $( table_selector + radio_selector_id ).prop( "checked", true ).trigger( "change" );
        } else {
          $( table_selector + ' input:radio[value="accept"]' ).removeProp( "checked" ).trigger( "change" );  
          $text_selector = $( table_selector + ' div.adjudicate :text' );
          $text_selector.prop( "disabled", true );  
          $text_selector.removeClass( "candidate primary intrusion variant" );
          $text_selector.val( "" );
          $text_selector.attr( "value", "" );
        }

        configure_ui();
      } );// end checkbox click

    } );
  </script>

{% endblock javascript %}

{% block widget %}
  
  <div class="spacer"></div>

  {% if entry_data is empty %}

    <caption style="text-align: left;">
      <strong>No adjudication required. Please press Prev, Next or Quit</strong>
    </caption>

  {% else %}

    <table id="{{ widget.full }}__entry_table"
           border="1">

      <thead>
        <tr style="height:40px">
          <th>Entry</th>
          <th colspan="4">"{{ user_1 }}"</th>
          <th colspan="4">"{{ user_2 }}"</th>
          <th colspan="3">Adjudicate</th>
        </tr>
        <tr>
          <td></td>
          <th>Yes</th>
          <th>No</th>
          <th>Variant</th>
          <td></td>
          <th>Yes</th>
          <th>No</th>
          <th>Variant</th>
          <td></td>
          <th>Yes</th>
          <th>No</th>
          <th>Variant</th>
        </tr>
      </thead>

      <tbody>
      {% for entry in entry_data %}
        <tr>
          {% if entry.word_1 is defined %}

            <td class="heading" style="text-align:center">{{ entry.word_1 }}</td>

            <td>
              <input type="radio"
                id="{{ entry.id_1 }}__yes"
                name="{{ entry.word_id_1 }}__1"
                value="yes"
                {{ entry.selection_1 == 'yes' ? "checked" : "" }}/>
            </td>
            <td>
              <input type="radio"
                id="{{ entry.id_1 }}__no"
                name="{{ entry.word_id_1 }}__1"
                value="no"
                {{ entry.selection_1 == 'no' ? "checked" : "" }}/>
            </td>
            <td style="white-space: nowrap">
              <input type="radio"
                id="{{ entry.id_1 }}__variant"
                name="{{ entry.word_id_1 }}__1"
                value="variant"
                {{ entry.selection_1 == 'variant' ? "checked" : "" }}/>
              <input type="text"
                id="{{ entry.id_1 }}__variant"
                {% if entry.word_candidate_1 is defined %}
                  class="{{ entry.classification_1 }}"
                  value="{{ entry.word_candidate_1 }}"
                {% endif %}
                readonly
                disabled/>
            </td>

            {% if entry.adjudicate is defined %}
              <td bgcolor=#B1F3B1>
                <div class="radio__accept__1">
                  <input type="radio"
                    id="{{ entry.id_1 }}__accept"
                    name="{{ entry.word_id_1 }}__accept"
                    value="accept"/>
                  <label for="{{ entry.id_1 }}__accept">Accept</label>
                </div>
              </td>
            {% else %}
              <td></td>
            {% endif %}

            <td>
              <input type="radio"
                id="{{ entry.id_2 }}__yes"
                name="{{ entry.word_id_2 }}__2"
                value="yes"
                {{ entry.selection_2 == 'yes' ? "checked" : "" }}/>
            </td>
            <td>
              <input type="radio"
                id="{{ entry.id_2 }}__no"
                name="{{ entry.word_id_2 }}__2"
                value="no"
                {{ entry.selection_2 == 'no' ? "checked" : "" }}/>
            </td>
            <td style="white-space: nowrap">
              <input type="radio"
                id="{{ entry.id_2 }}__variant"
                name="{{ entry.word_id_2 }}__2"
                value="variant"
                {{ entry.selection_2 == 'variant' ? "checked" : "" }}/>
              <input type="text"
                id="{{ entry.id_2 }}__variant"
                {% if entry.word_candidate_2 is defined %}
                  value="{{ entry.word_candidate_2 }}"
                  class="{{ entry.classification_2 }}"
                {% endif %}
                readonly
                disabled/>
            </td>

            {% if entry.adjudicate is defined %}
              <td bgcolor=#B1F3B1>
                <div class="radio__accept__2">
                  <input type="radio"
                    id="{{ entry.id_2 }}__accept"
                    name="{{ entry.word_id_2 }}__accept"
                    value="accept"/>
                  <label for="{{ entry.id_2 }}__accept">Accept</label>
                </div>   
              </td>
            {% else %}
              <td></td>
            {% endif %}

            {% if entry.adjudicate is defined %} 
              <td>
                <div class="adjudicate">
                  <input type="radio"
                    id="{{ entry.id_1 }}__{{ entry.id_2 }}__yes"
                    name="{{ entry.id_1 }}__{{ entry.id_2 }}__adjudicate"
                    value="yes"/>
                </div>
              </td>
              <td>
              <div class="adjudicate">
                <input type="radio"
                  id="{{ entry.id_1 }}__{{ entry.id_2 }}__no"
                  name="{{ entry.id_1 }}__{{ entry.id_2 }}__adjudicate"
                  value="no"/>
              </div>
              </td>
              <td style="white-space: nowrap">
                <div class="adjudicate">
                  <input type="radio"
                    id="{{ entry.id_1 }}__{{ entry.id_2 }}__variant"
                    name="{{ entry.id_1 }}__{{ entry.id_2 }}__adjudicate"
                    value="variant"/>
                  <input type="text"
                    id="{{ entry.id_1 }}__{{ entry.id_2 }}__adjudicate"
                    disabled
                    value=""/>
                </div>
              </td>
            {% else %}
              <td></td><td></td><td></td>
            {% endif %}

          {% else %}

            <td class="heading" style="text-align:center">INTRUSION</td>

            <td colspan="2"></td>
            {% set intrusion_id_1 = '' %}
            {% set intrusion_id_2 = '' %}
            {% if entry.id_1 is defined %}
              {% set intrusion_id_1 = entry.id_1 %}
            {% else %}
              {% set intrusion_id_1 = entry.rank %}
            {% endif %}   
            {% if entry.id_2 is defined %}
              {% set intrusion_id_2 = entry.id_2 %}
            {% else %}
              {% set intrusion_id_2 = entry.rank %}
            {% endif %}   

            <td>
              <input type="text"
                id="{{ intrusion_id_1 }}__intrusion__source"
                readonly
                value="{{ entry.word_candidate_1 }}"
                class="{{ entry.classification_1 }}"/>
            </td>

            {% if entry.adjudicate is defined %}
              <td bgcolor=#B1F3B1>
                <div class="radio__accept__1">
                  <input type="radio"
                    id="{{ intrusion_id_1 }}__intrusion__accept"
                    name="{{ intrusion_id_1 }}__{{ intrusion_id_2 }}__accept"
                    value="accept"/>
                  <label for="{{ intrusion_id_1 }}__intrusion__accept">Accept</label>
                </div>  
              </td>
            {% else %}
              <td></td>
            {% endif %}  

            <td colspan="2"></td>

            <td>
              <input type="text"
                id="{{ intrusion_id_2 }}__intrusion__source"
                readonly
                value="{{ entry.word_candidate_2 }}"
                class="{{ entry.classification_2 }}"/>
            </td>

            {% if entry.adjudicate is defined %}
              <td bgcolor=#B1F3B1>
                <div class="radio__accept__2">
                  <input type="radio"
                    id="{{ intrusion_id_2 }}__intrusion__accept"
                    name="{{ intrusion_id_1 }}__{{ intrusion_id_2 }}__accept"
                    value="accept"/>
                  <label for="{{ intrusion_id_2 }}__intrusion__accept">Accept</label>
                </div>  
              </td>
            {% else %}
              <td></td>
            {% endif %}

            <td colspan="2"></td>

            {% if entry.adjudicate is defined %}
              <td>
                <div class="adjudicate">
                  <input type="text"
                    id="{{ intrusion_id_1 }}__{{ intrusion_id_2 }}__intrusion"
                    disabled/>
                </div>
              </td>
            {% else %}
              <td></td>
            {% endif %}  

          {% endif %}
        </tr>

      {% endfor %}

        <tr>
          <td colspan="4"></td>

          <td bgcolor=#B1F3B1>
            <input type="checkbox"
              id="{{ widget.full }}__accept__all__1"
              name="{{ widget.full }}__accept__all"
              value="all"/>
              <label for="{{ widget.full }}__accept__all__1">All</label>
          </td>

          <td colspan="3"></td>

          <td bgcolor=#B1F3B1>
            <input type="checkbox"
              id="{{ widget.full }}__accept__all__2"
              name="{{ widget.full }}__accept__all"
              value="all"/>
              <label for="{{ widget.full }}__accept__all__2">All</label>
          </td>

          <td colspan="3"></td> 
        </tr>

      </tbody>
    </table>

  {% endif %}

{% endblock widget %}
